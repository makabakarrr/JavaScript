# 闭包

## 1.概念

闭包：是一个拥有许多变量和绑定了这些变量的环境的表达式（通常是一个函数），因而这些变量也是表达式的一部分。

解释：当一个函数能够记住并访问到其所在的词法作用域及作用域链，特别强调是在其定义的作用域外进行的访问，此时该函数和其上层执行上下文（执行环境）共同构成闭包。

几个概念：

> 1、作用域：指变量或函数的使用范围，确定当前执行代码对变量的访问权限
>
> 2、词法作用域：词法作用域也叫静态作用域，是指作用域在词法分析阶段就确定了不会改变，javascript采用的是词法作用域，变量和函数的作用域在书写的时候就确定了。
>
> 3、动态作用域：在执行时根据程序得到流程信息来动态确定的，js中的this类似动态作用域，this的指向可以更换
>
> 2、上层执行上下文：

例子:词法作用域：

```javascript
var a = 1;
function fn1(){
	console.log(a);
}
function fn2(){
	var a = 2;
    fn1();
}
fn2();//1
```

结果输出1：执行fn1函数时，先从函数内部查找局部变量a，函数内部并没有a变量，根据书写位置查找上一层作用域，上一层作用域为全局作用域，找到全局变量a=1。

由此可见，***闭包存在以下几点特点：***

1. 闭包一定是函数对象；
2. 函数内部保持对上层作用域的引用；
3. 闭包和词法作用域、作用域链、垃圾回收机制等息息相关；
4. 当函数在其定义的作用域外被访问时，才产生闭包；
5. 闭包是有该函数和其上层执行上下文（执行环境）共同构成的



再来理解几个重要的概念：

**1.作用域链**

​		执行Js语句时，首先从当前的作用域查找所需的变量和函数，如果找不到则从它的上级作用域（包含它的作用域）内找，找不到再到上级作用域，直至全局作用域，我们将这成为作用域链。由此可见，作用域链本质上是一个指向变量对象的指针列表。

> 变量对象：每个执行环境都有一个与之关联的变量对象，保存执行环境中定义的所有变量和函数
>
> 执行环境：所有javascript代码都是在一个执行环境中被执行的，执行环境是一个概念一种机制，用来完成javascript运行时在作用域、生存期等方面的处理，包括以下分类：
> 		全局执行环境：js在文本浏览器中，全局执行环境的变量对象时window对象
>
> ​		局部执行环境：函数的执行环境，变量对象只在函数执行的过程中存在。当函数被调用时，会创建一个特殊的对象-活动对象，活动对象之后会作为当前执行环境的变量对象来使用

**2.执行环境的创建建立**

​		EC(Execution Context)： 执行环境（执行上下文），EC的简历分两个阶段：进入执行上下文（创建阶段）和执行阶段（激活、执行代码）

​		AO(Activation Object) 活动对象

​		VO(Variable Object) 变量对象

在函数的执行上下文中，VO是不能直接访问的，我们访问的是AO，AO是在进入函数的执行上下文是创建的

**创建阶段：**

​		解释器扫描传递给函数的参数、arguments，本地函数声明，本地变量声明，并创建EC队形，扫描的结果将完成VO（变量对象）的创建。内部 的执行顺序如下：

1.查找调用函数的代码；

2. 执行函数代码之前，先创建执行上下文；

3. 进入创建阶段：创建EC

   ​		初始化作用域链

   ​		创建变量对象

   ​		创建arguments对象

   ​		扫描函数形参

   ​		扫描上下文的函数声明

   ​		扫描上下文的变量声明

   ​		求出上下文内部“this”的值

   注意：该过程是有先后顺序的，如果变量名和已声明的函数名或者函数的参数名相同，不会影响已经存在的属性.创建EC的步骤如下

   ```javascript
var b = 123;
   function fun(i) {
   console.log(a);//undefined
      var a = 'hello';
      var b = function fb() { };
      function c() { }
      console.log(a);//'hello'
      this -> window
    }
    fun(123);
    console.log(b);
   
   // 在fun执行之前，创建的EC像下面这样：(创建阶段)
   funEC = {
      scopeChain: { ... },//作用域链
      AO: {//被当成VO使用
        arguments: {
          0: 123,//fun（123）传入的一个参数为123，arguments[0] = 123
          length: 1
        },
        i: 123,//形参
        c: pointer to function c()//函数声明
        a: undefined,//变量声明
        b: undefined
      },
      this: window//this的指向
    }
   ```
   
   **激活、执行代码阶段**
   
   在当前上下文解释、运行桉树代码，并随着代码一行行执行指定变量的值









